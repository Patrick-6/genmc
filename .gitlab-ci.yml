stages:
  - build
  - test
  - cleanup

before_script:
  - export TERM='xterm-256color'
  - printf "\ndeb http://ftp.debian.org/debian jessie main contrib non-free\ndeb-src http://ftp.debian.org/debian jessie main contrib non-free" >> /etc/apt/sources.list
  - printf "\ndeb http://ftp.debian.org/debian sid main contrib non-free\ndeb-src http://ftp.debian.org/debian sid main contrib non-free" >> /etc/apt/sources.list
  - apt-get update && apt-get install -y -qq bc g++ clang autoconf make automake libffi-dev zlib1g-dev libedit-dev
    clang-3.5 libclang-3.5-dev llvm-3.5 llvm-3.5-dev
    clang-3.8 libclang-3.8-dev llvm-3.8 llvm-3.8-dev
    clang-4.0 libclang-4.0-dev llvm-4.0 llvm-4.0-dev
    clang-6.0 libclang-6.0-dev llvm-6.0 llvm-6.0-dev
    clang-7   libclang-7-dev   llvm-7   llvm-7-dev
  - cd C++
variables:
  GIT_STRATEGY: fetch

### TEMPLATES

.build:llvm_job: &llvm_build
  script:
    - autoreconf --install
    - ./configure --with-llvm=`llvm-config-${llvm_build_version} --prefix`
    - make
  artifacts:
    paths:
      - C++/

.test:llvm_job: &llvm_test
  script:
    - make test
  artifacts:
    paths:
      - C++/

build:llvm-3.8:
  stage: build
  variables:
    llvm_build_version: "3.8"
  <<: *llvm_build

build:llvm-4.0:
  stage: build
  variables:
    llvm_build_version: "4.0"
  <<: *llvm_build

### DIFFERENT BUILDS

build:llvm-3.5:
  stage: build
  variables:
    CXXFLAGS: "-D_GLIBCXX_USE_CXX11_ABI=0"
    llvm_build_version: "3.5"
  <<: *llvm_build

build:llvm-3.8:
  stage: build
  variables:
    CXX: "clang++-3.8"
    llvm_build_version: "3.8"
  <<: *llvm_build

build:llvm-4.0:
  stage: build
  variables:
    llvm_build_version: "4.0"
  <<: *llvm_build

build:llvm-6.0:
  stage: build
  variables:
    llvm_build_version: "6.0"
  <<: *llvm_build

build:llvm-7:
  stage: build
  variables:
    llvm_build_version: "7"
  <<: *llvm_build

### TESTS

test:llvm-3.5:
  stage: test
  dependencies:
    - build:llvm-3.5
  <<: *llvm_test

test:llvm-3.8:
  stage: test
  dependencies:
    - build:llvm-3.8
  <<: *llvm_test

test:llvm-4.0:
  stage: test
  dependencies:
    - build:llvm-4.0
  <<: *llvm_test

test:llvm-6.0:
  stage: test
  dependencies:
    - build:llvm-6.0
  <<: *llvm_test

test:llvm-7:
  stage: test
  dependencies:
    - build:llvm-7
  <<: *llvm_test

### CLEANUPS

cleanup_files:
  stage: cleanup
  script:
    - make distclean
